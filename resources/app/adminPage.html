<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Quiz Results</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- <link rel="stylesheet" href="style.css" /> -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }


    body.dark {
      background-color: #121212;
      color: #f9f9f9;
    }

    body.dark button,
    body.dark .red {
      background-color: #333;
      color: #fff;
    }

    body.dark details {
      background: #1a1a1a;
      color: #ddd;
    }

    body.dark summary {
      color: #fff;
      background: #333;
    }

    body.dark th,
    body.dark td,
    body.dark select,
    body.dark input[type="date"],
    body.dark input[type="text"],
    body.dark #logoutBtn {
      background: #1e1e1e;
      border-color: #444;
      color: #ddd;
    }

    body {
      font-family: Arial, sans-serif;
      padding-left: min(4em, 5%);
      padding-right: min(4em, 5%);
      font-family: Arial, sans-serif;
      color: #222;
      height: 100vh;
      background-color: #f0f0f0;
      transition: background-color 0.3s, color 0.3s;
      line-height: 1.5;
      /* display: none; */
    }


    .dark-mode {
      background: #111;
      color: #eee;
    }


    /* main{
  padding:10px;
} */
    h2 {
      margin-bottom: 5px;
    }

    textarea {
      width: 100%;
      margin-top: 5px;
      border: none;

    }

    .score-input {
      width: 60px;
      margin-left: 10px;
    }

    .section {
      margin-top: 10px;
    }

    .student-box {
      border: 1px solid #ccc;
      padding: 1em;
      margin: 1em 0;
      border-radius: 8px;
      background: #f9f9f9;
    }

    details summary {
      font-size: 1.1em;
      cursor: pointer;
      background: #ddd;
      padding: 0.5em;
      border-radius: 4px;
    }

    .section {
      margin: 1em 0;
    }

    .mcq-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
      min-width: 600px;
    }

    .mcq-table th,
    .mcq-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: clamp(0.9rem, 2vw, 1rem);
    }

    .mcq-table th {
      background-color: #3498db;
      color: white;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
    }

    .mcq-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .mcq-table tr:hover {
      background-color: #f1f1f1;
    }


    .score-input {
      width: 60px;
      margin-left: 5px;
    }

    .class-group>summary {
      color: #444;
      padding: 0 20px;
      font-size: 1.2em;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .section-group>summary {
      color: #444;
      padding: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 5px;
    }

    textarea,
    input,
    input[type="text"] ,#import{
      margin: 10px 2px;
      padding: clamp(.5rem, 2vw, .6rem);
      font-size: clamp(.8rem, 2vw, 1rem);
      outline: none;
      border: none;
    }

    textarea,
    input:focus,
    input[type="text"]:focus, #import:focus{
      outline: none;
      border: none;
    }

    .update-btn,
    .delete-btn,
    .btn,
    .pdf-sec,
    .blue,
    .btn.red,
    .csv-btn,
    .pdf-btn {
      margin: 0.2rem 0.25rem;
      color: white;
      border: none;
      cursor: pointer;
      font-size: clamp(0.8rem, 2vw, 1rem);
      transition: background-color 0.3s;
      padding: clamp(.8rem, 2vw, .8rem);
      border-radius: 6px;

    }


    .update-btn,
    .csv-btn {
      background-color: #28a745;
    }

    .blue {
      background: #337ab7;
    }

    .btn.red {
      background: #b30000;
    }

    .pdf-sec {
      background-color: #4A90E2;
    }

    .pdf-btn {
      background-color: #934;
    }

    .btn.red:hover,
    .btn:hover,
    .pdf-btn:hover,
    .csv-btn:hover {
      opacity: 0.9;
    }

    .delete-btn {
      background-color: #4A90E2;
    }

    .download-btn {
      background-color: tomato;
    }

    .btn:focus {
      outline: none;
    }


    .hidden {
      display: none;
    }

    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #c0392b;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
    }

    .theme-toggle {
      position: fixed;
      top: .6rem;
      left: 1rem;
      background: transparent !important;
      border: none;
      font-size: clamp(1rem, 2vw, 1.5rem);
      cursor: pointer;
    }

    .school-header {

      margin-top: 12px;
      text-align: center;

    }

    .school-logo {
      width: 200px;
      height: auto;
      object-fit: contain;

    }

    body.dark .school-logo {
      filter: invert(1);
    }

    .table-responsive {
      overflow-x: auto;
      width: 100%;
      background: white;
      border-radius: 10px;
      padding: 10px;
    }

    .table-responsive table {
      width: 100%;
      border-collapse: collapse;

    }

    header {
      padding-top: 40px;
      margin-bottom: 5px;
      font-size: clamp(1.2rem, 2vw, 1.5rem);
    }

    header h3 {
      font-size: clamp(1.2rem, 2vw, 1.8rem);
    }

    header h2 {
      text-align: center;
      font-size: clamp(1.2rem, 2vw, 1.6rem);
      margin-bottom: 20px;
    }

    .summary {
      font-size: clamp(1rem, 2vw, 1.4rem);
      cursor: pointer;
      color: #333;
      margin: 20px 0px;

    }

    body.dark .summary,
    body.dark header {

      color: #fff;

    }

    .student-info {
      margin: 20px 0px;
    }

    .mcq-title {
      margin-top: 20px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2ecc71;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      transition: opacity 0.5s ease;
      z-index: 1000;
    }
    .custom-upload-btn {
  display: inline-block;
  background-color: #ff6600; /* Orange or any color you want */
  color: white;
  padding: 10px 16px;
  font-size: 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.custom-upload-btn:hover {
  background-color: #e65c00;
}

  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>

<body id="admin-body">
  <main>
    <header>
      <h2> üìä Third Term Exam Results</h2>
      <h3>üìö Grouped by Class</h3>
      <!-- <button id="theme-toggle">Toggle Theme</button> -->
      <button class="theme-toggle" id="theme-toggle">üåû</button>
    </header>

    <!-- <button id="theme-toggle">Toggle Theme</button> -->
    <button id="download-csv" class="btn csv-btn">Download CSV</button>
    <button class="btn pdf-btn" onclick="downloadClasswisePDFs()"> üìä Download All Results</button>
    <button class="btn pdf-btn" onclick="downloadClasswiseScoress()"> üìä Download All Scores</button>
    <!-- <button onclick="clearResults()">Clear All</button> -->


    <button id="download-by-class" class="btn red">Download Class</button>
    <button id="download-by-section" class="btn pdf-sec"> üì• Download Section</button>
    <button class="btn pdf-sec" onclick="downloadAllPDFs()">Download Individual Scores</button>
   


    <button id="clear-all-results-btn" class="btn red"> üóëÔ∏è Clear All</button>
    <!-- <button id="adminLogoutBtn">Logout</button> -->
    <button id="logoutBtn"> üîì Logout</button>
     <input type="file" id="fileInput" multiple accept=".json" onchange="handleImportFiles(this.files)" hidden>
<label for="fileInput" class="custom-upload-btn">üìÇ Import Results</label>
    <input id="classFilter" placeholder="Filter by Class">
    <input id="sectionFilter" placeholder="Filter by Section">
    

    <input id="searchInput" type="text" placeholder="Search by Name">
    <div id="summary"></div>
    <div id="toast"
      style="position:fixed; bottom:20px; right:20px; background:green; color:#fff; padding:10px 20px; border-radius:5px; display:none; z-index:1000;">
    </div>
    <div id="admin-panel"></div>

  </main>
  <script>

    function normalizeKey(str = "") {
      return str.trim().toLowerCase().replace(/\s+/g, "").replace(/[^a-z0-9]/g, "");
    }

    function getManualScore(scores) {
      return Object.values(scores || {}).reduce((sum, val) => {
        const num = parseFloat(val);
        return sum + (!isNaN(num) ? num : 0);
      }, 0);
    }

    // Theme toggle
    const modeToggle = document.getElementById("theme-toggle");
    modeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      modeToggle.textContent = document.body.classList.contains("dark") ? "üåô" : "üåû";
    };
    if (localStorage.getItem("adminLoggedIn") !== "yes") {
      window.location.href = "login.html";
    }
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("admin-panel");
      const summary = document.getElementById("summary");
      const classFilter = document.getElementById("classFilter");
      const sectionFilter = document.getElementById("sectionFilter");
      const searchInput = document.getElementById("searchInput");

      let questions = [];
      try {
        questions = await fetch("questions.json").then(res => res.json());
      } catch (err) {
        container.innerHTML = "<p>Failed to load questions.json</p>";
        console.error(err);
        return;
      }

      let results = JSON.parse(localStorage.getItem("quizResults") || "[]");

      // Ensure uniqueness by combining name, class, and date
      const seen = new Set();
      results = results.filter(r => {
        const key = `${r.name.toLowerCase()}|${r.class.toLowerCase()}|${r.date}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
      window.results = results;
      function normalizeClassSection(input = "") {
        const raw = (input || "")
          .toLowerCase()
          .replace(/\s+/g, '')     // remove all spaces
          .replace(/[^a-z0-9]/g, ''); // remove non-alphanumerics

        const sectionCorrections = {
          dignity: ["dignity"],
          valor: ["valor",],
          humility: ["humility"],
          serenity: ["serenity"],
          excellence: ["excellence"],
          creativity: ["creativity"],
          determination: ["determination"],
          gratitude: ["gratitude"],
          virtuous: ["virtuous"],
          chastity: ["chastity"]
        };

        const classMap = {
          jss1: "JSS1",
          jss2: "JSS2",
          jss3: "JSS3",
          ss1: "SS1",
          ss2: "SS2",
          ss3: "SS3"
        };

        let classKey = "UNKNOWN";
        let sectionKey = "Unknown";

        for (let key in classMap) {
          if (raw.includes(key)) {
            classKey = classMap[key];
            break;
          }
        }

        for (let section in sectionCorrections) {
          if (sectionCorrections[section].some(alt => raw.includes(alt))) {
            sectionKey = capitalize(section);
            break;
          }
        }

        return {
          classKey,
          section: sectionKey,
          classFull: `${classKey} ${capitalize(sectionKey)}`
        };
      }


      function capitalize(s = "") {
        return s.charAt(0).toUpperCase() + s.slice(1);
      }
      const sectionColors = {
        "JSS1 Dignity": "#D0E6A5",
        "JSS1 Valor": "#FFDD94",
        "JSS2 Humility": "#FCAB64",
        "JSS2 Serenity": "#ACD8AA",
        "JSS3 Excellence": "#FFD3B5",
        "SS1 Creativity": "#FFAAA6",
        "SS1 Determination": "#B5EAD7",
        "SS2 Gratitude": "#C7CEEA",
        "SS2 Virtuous": "#FFDAC1",
        "SS3 Chastity": "#E2F0CB"
      };

      function groupAndSortResults(results) {
        const classOrder = ["JSS1", "JSS2", "JSS3", "SS1", "SS2", "SS3"];
        const grouped = {};

        results.forEach(r => {
          const { classKey, section } = normalizeClassSection(r.class);
          if (!grouped[classKey]) grouped[classKey] = {};
          if (!grouped[classKey][section]) grouped[classKey][section] = [];
          grouped[classKey][section].push(r);
        });

        // Sort students by name inside each section
        for (let cls in grouped) {
          for (let sec in grouped[cls]) {
            grouped[cls][sec].sort((a, b) => a.name.localeCompare(b.name));
          }
        }

        // Flatten the grouped object into a sorted array
        const sorted = [];
        classOrder.forEach(cls => {
          if (grouped[cls]) {
            Object.keys(grouped[cls]).sort().forEach(sec => {
              sorted.push(...grouped[cls][sec]);
            });
          }
        });

        return sorted;
      }

      // === Apply Grouping & Render ===
      results = groupAndSortResults(results);
      // renderResults(results);
      renderGroupedResultsWithCounts(results);

      updateSummary(results);

      function normalize(str = "") {
        return str.toLowerCase()
          .replace(/\s+/g, '')
          .replace(/[^a-z0-9]/g, '')
          .replace(/[^a-z0-9]/g, '')                 // remove special chars
          .replace(/^jsss/, 'jss')                   // fix overtyped jsss
          .replace(/^sss/, 'ss')                     // fix sss ‚Üí ss

      }

      function normalizeClassName(classStr = "") {
        const clean = classStr.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');

        // Map common patterns to standard form
        if (clean.startsWith("jss1")) return "jss1";
        if (clean.startsWith("jss2")) return "jss2";
        if (clean.startsWith("jss3")) return "jss3";
        if (clean.startsWith("ss1")) return "ss1";
        if (clean.startsWith("ss2")) return "ss2";
        if (clean.startsWith("ss3")) return "ss3";
        return clean;
      }



      function escapeHTML(str = "") {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }
      function keyToTitle(key) {
        return key.charAt(0).toUpperCase() + key.slice(1);
      }

      function groupByClassAndSection(results) {
        const grouped = {};

        results.forEach(r => {
          const { classKey, section } = normalizeClassSection(r.class);
          if (!grouped[classKey]) grouped[classKey] = {};
          if (!grouped[classKey][section]) grouped[classKey][section] = [];
          grouped[classKey][section].push(r);
        });

        return grouped;
      }

      function renderStudentBox(r) {
        const subjScores = r.subjScores || {};
        const theoryScores = r.theoryScores || {};
        const manualScore = getManualScore(subjScores) + getManualScore(theoryScores);
        const key = `${r.name.toLowerCase()}_${r.class.toLowerCase()}`;

        const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];
        const mcq = shuffled.filter(q => q.type === "mcq");
        const subjective = shuffled.filter(q => q.type === "subjective");
        const theory = shuffled.filter(q => q.type === "theory");

        let mcqScore = 0;
        (r.answers || []).forEach((ans, i) => {
          if (mcq[i] && mcq[i].answer === ans) mcqScore++;
        });

        const totalScore = mcqScore + manualScore;

        return `
  <details class="student-box" data-key="${key}" open>
    <summary><strong>${r.name} (${r.class})</strong> ‚Äî <em>${r.date}</em></summary>
    <div class="student-info">
      <p><strong>MCQ Score:</strong> <span class="mcq-score">${mcqScore}</span> / ${mcq.length}</p>
      <p><strong>Manual Score:</strong> <span class="manual-score">${manualScore}</span></p>
      <p><strong>Total Score:</strong> <span class="total-score">${totalScore}</span></p>
    </div>

    <div class="table-responsive">
      <table class="mcq-table">
        <thead><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th></tr></thead>
        <tbody>
          ${mcq.map((q, i) => {
          const studentAns = r.answers?.[i] || "None";
          const isCorrect = studentAns === q.answer;
          const ansColor = studentAns === "None" ? "gray" : isCorrect ? "green" : "red";
          return `
              <tr>
                <td><strong>Q${i + 1}:</strong> ${escapeHTML(q.question || "Unknown")}</td>
                <td style="color:${ansColor}">${escapeHTML(studentAns)}</td>
                <td style="color:green">${escapeHTML(q.answer || "?")}</td>
              </tr>
            `;
        }).join("")}
        </tbody>
      </table>
    </div>

    <div class="table-responsive">
    <h4>Subjective</h4>
${subjective.map((q, idx) => {
          const qid = `subj_${idx}`;
          const ans = r.subjective?.[qid] || "None";
          const score = subjScores[qid] || 0;
          const scoreStyle = `border: 2px solid ${score == 0 ? 'red' : 'green'};`;
          const comment = r.subjComments?.[qid] || "";
          return `
    <div style="margin-top: 15px;">
      <p><strong>Q${idx + 1}:</strong> ${escapeHTML(q.question)}</p>
      <p style="margin-bottom: -15px;"><strong>Answer:</strong></p>
      <textarea readonly rows="2" style="width:100%";margin-top: -25px;>${ans}</textarea>
      <div>
        <label style="font-weight: bold;">Score (10): </label>
        <input type="number" min="0" max="10" value="${score}"
          data-type="subj" data-id="${qid}" style="width: 60px; margin-left: 10px; ${scoreStyle}">
      </div>
    </div>
  `;
        }).join("")}

<h4 style="margin: 10px 0;">Theory</h4>
${theory.map((q, idx) => {
          const qid = `theory_${idx}`;
          const ans = r.theory?.[qid] || "None";
          const score = theoryScores[qid] || 0;
          const scoreStyle = `border: 2px solid ${score == 0 ? 'red' : 'green'};`;
          const comment = r.theoryComments?.[qid] || "";
          return `
    <div style="margin-bottom: 15px;">
      <p><strong>Q${idx + 1}:</strong> ${escapeHTML(q.question)}</p>
      <p style="margin-bottom: -15px;"><strong>Answer:</strong></p>
      <textarea readonly rows="2" style="width:100%";margin-top: -25px;>${ans}</textarea>
      <div>
        <label style="font-weight: bold;">Score (10): </label>
        <input type="number" min="0" max="10" value="${score}"
          data-type="theory" data-id="${qid}" style="width: 60px; margin-left: 10px; ${scoreStyle}">
      </div>
    </div>
  `;
        }).join("")}

    </div>

    <button class="update-btn">Update Score</button>
    <button class="delete-btn" onclick="deleteStudent('${r.name.toLowerCase().trim().replace(/\s+/g, '')}_${r.class.toLowerCase().trim().replace(/\s+/g, '')}')">Delete</button>
  </details>
  `;
      }

      // ‚úÖ Update manual score
      function updateManualScore(container) {
        const key = container.dataset.key;
        const [nameKey, classKey] = key.split("_");
        const results = JSON.parse(localStorage.getItem("quizResults") || "[]");

        const student = results.find(r =>
          `${r.name.toLowerCase()}_${r.class.toLowerCase()}` === key
        );


        if (!student) return showToast("‚ùå Student record not found");

        const subjScores = {};
        const theoryScores = {};

        container.querySelectorAll("input[data-type='subj']").forEach(input => {
          const val = parseFloat(input.value);
          subjScores[input.dataset.id] = isNaN(val) ? 0 : val;

        });
        container.querySelectorAll("input[data-type='theory']").forEach(input => {
          const val = parseFloat(input.value);
          theoryScores[input.dataset.id] = isNaN(val) ? 0 : val;

        });

        student.subjScores = subjScores;
        student.theoryScores = theoryScores;

        // Update score and save
        const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];
        const mcq = shuffled.filter(q => q.type === "mcq").slice(0, 18);

        let mcqScore = 0;
        (student.answers || []).forEach((ans, i) => {
          if (mcq[i] && mcq[i].answer === ans) mcqScore++;
        });

        const manualScore = getManualScore(subjScores) + getManualScore(theoryScores);
        const totalScore = mcqScore + manualScore;

        student.score = mcqScore;
        student.totalScore = totalScore;

        localStorage.setItem("quizResults", JSON.stringify(results));


        // Re-render the updated student box
        const newHTML = renderStudentBox(student);
        container.outerHTML = newHTML;
        showToast("‚úÖ Score updated");

        // Rebind event listener
        setTimeout(() => bindUpdateButtons(), 100);
      }


      // ‚úÖ Bind update buttons
      function bindUpdateButtons() {
        document.querySelectorAll(".update-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const box = btn.closest(".student-box");
            updateManualScore(box);
          });
        });
      }

      // ‚úÖ Load and render all student results
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("admin-panel") || document.body;
        const results = JSON.parse(localStorage.getItem("quizResults") || "[]");
        container.innerHTML = results.map(renderStudentBox).join("");
        bindUpdateButtons();
      });


      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, duration);
      }

      window.deleteStudent = function (key) {
        const confirmDelete = confirm("Are you sure you want to delete this student's result?");
        if (!confirmDelete) return;

        const normalize = str => (str || "").toLowerCase().trim().replace(/\s+/g, '');
        const inputKey = normalize(key);

        let results = JSON.parse(localStorage.getItem("quizResults") || "[]");

        const originalLength = results.length;

        results = results.filter(r => {
          const resultKey = `${normalize(r.name)}_${normalize(r.class)}`;
          return resultKey !== inputKey;
        });

        if (results.length === originalLength) {
          showToast("Student not found or key mismatch");
          return;
        }

        localStorage.setItem("quizResults", JSON.stringify(results));

        if (typeof renderGroupedResultsWithCounts === "function") {
          renderGroupedResultsWithCounts(results);
        } else {
          location.reload();
        }

        if (typeof updateSummary === "function") updateSummary(results);

        showToast("Student deleted successfully!");
      };

      function renderGroupedResultsWithCounts(results) {
        const grouped = groupByClassAndSection(results);
        const container = document.getElementById("admin-panel")
        container.innerHTML = "";

        const classOrder = ["JSS1", "JSS2", "JSS3", "SS1", "SS2", "SS3"];
        classOrder.forEach(cls => {
          const sections = grouped[cls];
          if (sections) {
            let totalClassCount = 0;
            const classDiv = document.createElement("div");
            classDiv.innerHTML = `<h2>${cls}</h2>`;

            Object.entries(sections).sort().forEach(([section, students]) => {
              totalClassCount += students.length;
              const color = sectionColors[`${cls} ${section}`] || "#f0f0f0";
              const sectionDiv = document.createElement("div");
              sectionDiv.style.background = color;
              sectionDiv.style.padding = "10px";
              sectionDiv.style.margin = "5px 0";
              sectionDiv.style.border = "1px solid #ccc";
              sectionDiv.innerHTML = `<h3>${section} (${students.length} students)</h3>`;

              students.forEach(student => {
                sectionDiv.innerHTML += renderStudentBox(student);
              });

              classDiv.appendChild(sectionDiv);
            });

            // Append total next to the class title
            const header = classDiv.querySelector("h2");
            header.innerHTML = `${cls} <span style="font-size: 14px; color: #666;">(${totalClassCount} students)</span>`;

            container.appendChild(classDiv);
          }
        });
      }

      function updateSummary(data) {
        const totalStudents = data.length;
        const totalQuestions = questions.length;
        const avgScore = (data.reduce((sum, r) => sum + (r.score || 0) + getManualScore(r.subjScores) + getManualScore(r.theoryScores), 0) / totalStudents).toFixed(1);

        summary.innerHTML = `
    <div class="summary">
      <p>Total Students: ${totalStudents}</p>
      <p>Average Score: ${avgScore}</p>
      <p>Total Questions: ${totalQuestions}</p>
      </div>
    `;
      }
      function getFullClassNameFromSection(sectionInput) {
        const section = normalize(sectionInput);
        const map = {
          dignity: 'JSS1 Dignity',
          valor: 'JSS1 Valor',
          humility: 'JSS2 Humility',
          serenity: 'JSS2 Serenity',
          excellence: 'JSS3 Excellence',
          creativity: 'SS1 Creativity',
          determination: 'SS1 Determination',
          gratitude: 'SS2 Gratitude',
          virtuous: 'SS2 Virtuous'

          // Add more mappings as needed
        };

        // Try direct match
        for (const key in map) {
          if (section.includes(key)) return map[key];
        }

        // Fallback
        return `Section: ${sectionInput}`;
      }

      function applyFilters() {
        const classVal = normalize(classFilter.value);    // e.g., ss1
        const sectionVal = normalize(sectionFilter.value); // e.g., dignity
        const searchVal = normalize(searchInput.value);   // e.g., john

        const filtered = results.filter(r => {
          const fullClass = normalize(r.class);           // e.g., ss1dignity, ss1creativity
          const name = normalize(r.name);                 // e.g., john

          const classMatch = classVal ? fullClass.startsWith(classVal) : true;

          let sectionMatch = true;
          if (sectionVal) {
            // Match if section keyword exists anywhere in class string
            sectionMatch = fullClass.includes(sectionVal);
          }

          const searchMatch = !searchVal || name.includes(searchVal);

          return classMatch && sectionMatch && searchMatch;
        });

        renderGroupedResultsWithCounts(filtered);
        updateSummary(filtered);
      }





      classFilter.oninput = sectionFilter.oninput = searchInput.oninput = applyFilters;
      // renderResults(results);
      renderGroupedResultsWithCounts(results);

      updateSummary(results);

      document.querySelectorAll(".score-input").forEach(input => {
        input.addEventListener("input", () => {
          const index = +input.dataset.index;
          const id = input.dataset.id;
          const type = input.dataset.type;
          const val = parseInt(input.value) || 0;

          if (!results[index][`${type}Scores`]) results[index][`${type}Scores`] = {};
          results[index][`${type}Scores`][id] = val;

          const subjScores = results[index].subjScores || {};
          const theoryScores = results[index].theoryScores || {};
          const manual = getManualScore(subjScores) + getManualScore(theoryScores);
          const total = (results[index].score || 0) + manual;

          document.getElementById(`manual-${index}`).textContent = manual;
          document.getElementById(`total-${index}`).textContent = total;

          localStorage.setItem("quizResults", JSON.stringify(results));
        });
      });


      document.getElementById("download-by-class").onclick = () => {
        const classVal = normalize(classFilter.value);
        if (!classVal) return alert("Please enter a class name to filter and download.");

        // üîç Filter students who belong to this class (e.g. JSS1 will match JSS1 Dignity, JSS1 Valor)
        const filtered = results.filter(r => normalize(r.class).startsWith(classVal));

        if (!filtered.length) return alert("No results found for that class.");

        // üßæ Call your updated exportToPDF function
        const classTitle = classVal.toUpperCase();
        exportToPDF(filtered, `${classTitle}_GroupedResults.pdf`, `${classTitle} Students Results by Section`, true);

      };


      document.getElementById("download-by-section").onclick = () => {
        const sectionVal = normalize(sectionFilter.value);
        if (!sectionVal) return alert("Please enter a section name.");

        const filtered = results.filter(r => normalize(r.class).includes(sectionVal));
        if (!filtered.length) return alert("No results found for that section.");

        const fullClass = filtered[0].class || sectionFilter.value.trim();
        exportToPDF(filtered, `${fullClass.replace(/\s+/g, '_')}_results.pdf`, `${fullClass} Student Results`, false);
      };


      // Final exportToPDF function with class title and average total score fixed


      function exportToPDF(studentList, filename = "filtered_results.pdf", customTitle = "Filtered Student Results", groupedByClass = true) {

        const doc = new jspdf.jsPDF();
        const logo = new Image();
        logo.src = 'logo-min.png';

        logo.onload = () => {
          let y = 10;
          const pageHeight = doc.internal.pageSize.height;
          const lineSpacing = 6;
          const studentGap = 10;
          let totalScoreSum = 0;
          let totalStudents = 0;

          doc.addImage(logo, 'PNG', 50, y, 45, 18);
          doc.setFontSize(16);
          doc.text(customTitle, 70, y + 9);
          y += 25;

          // Group students by full class/section
          const grouped = {};
          studentList.forEach(r => {
            const className = r.class?.trim() || "Unknown";
            if (!grouped[className]) grouped[className] = [];
            grouped[className].push(r);
          });

          const sortedSections = Object.keys(grouped).sort((a, b) => a.localeCompare(b));

        
          sortedSections.forEach((section, idx, arr) => {
            const students = grouped[section];
            let sectionScoreSum = 0;
            if (idx > 0) {
              y += 15; // Increased gap between sections
            }
            // if (groupedByClass && arr.length > 1) {
            //   doc.setFontSize(14);
            //   doc.setTextColor(0, 31, 63);
            //   doc.text(`${section}`, 50, y, { align: "right" });
            //   y += 6;
            // }
            if (groupedByClass && arr.length > 1) {
              doc.setFontSize(idx > 0 ? 16 : 14); // Larger font for 2nd section onward
              doc.setTextColor(0, 31, 63);
              doc.text(`${section}`, 45, y, { align: "right" });
              y += 6;
            }

            y += 8;

            // ... student rendering logic ...


            students.forEach((r, index) => {
              if (y > pageHeight - 60) {
                doc.addPage();
                y = 10;
              }

              doc.setFontSize(13);
              doc.setTextColor(0, 31, 63);
              const leftY = y;
              doc.text(`Name: ${r.name}`, 15, leftY);
              doc.text(`Class: ${r.class}`, 15, leftY + lineSpacing);
              doc.text(`Date: ${r.date}`, 15, leftY + lineSpacing * 2);

              const getManualScore = obj => Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);
              const subjScore = getManualScore(r.subjScores || {});
              const theoryScore = getManualScore(r.theoryScores || {});
              const manualScore = subjScore + theoryScore;
              const mcqScore = typeof r.score === "number" ? r.score : 0;
              const total = mcqScore + manualScore;

              totalScoreSum += total;
              sectionScoreSum += total;
              totalStudents++;

              const scoreLines = [
                `MCQ Score: ${mcqScore}`,
                `Manual Score: ${manualScore}`,
                `Total Score: ${total}`
              ];

              const rightX = 140;
              scoreLines.forEach((line, idx) => {
                doc.text(line, rightX, leftY + idx * lineSpacing);
              });

              y = leftY + scoreLines.length * lineSpacing;

              const key = `${r.name.toLowerCase()}_${r.class.toLowerCase()}`;
              const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];
              const mcq = shuffled.filter(q => q.type === "mcq");

              const mcqData = mcq.map((q, i) => [
                `Q${i + 1}: ${q.question || 'Unknown'}`,
                r.answers?.[i] || "Not answered",
                q.answer || "?"
              ]);

              doc.autoTable({
                startY: y,
                head: [["Question", "Your Answer", "Correct"]],
                body: mcqData,
                styles: { fontSize: 11, cellPadding: 2 },
                headStyles: { fillColor: [0, 31, 63], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 0 },
                didDrawPage: data => {
                  y = data.cursor.y + 5;
                }
              });

              const addAnswerTable = (title, typeKey, scores, color) => {
                const questions = shuffled.filter(q => q.type === typeKey);
                const answers = typeKey === "subjective" ? r.subjective || {} : r.theory || {};

                let sectionTotalScore = 0;

                const rows = questions.map((q, idx) => {
                  const questionText = q.question || `Q${idx + 1}`;
                  const prefix = typeKey === "subjective" ? "subj" : "theory";
                  const key = `${prefix}_${idx}`;

                  const answerRaw = answers[key];
                  const scoreRaw = scores[key];

                  const answered = typeof answerRaw !== "undefined" && answerRaw !== "";
                  const scoreNum = typeof scoreRaw === "number" ? scoreRaw : parseInt(scoreRaw) || 0;

                  sectionTotalScore += scoreNum;

                  const answer = answered ? `${answerRaw}` : `Not answered`;
                  const scoreDisplay = scoreNum.toString();

                  return [
                    questionText,
                    answer,
                    { content: scoreDisplay, styles: { textColor: scoreNum === 0 ? [192, 57, 43] : [39, 174, 96] } }
                  ];
                });

                if (!rows.length) return;

                doc.setFontSize(13);
                doc.text(`${title} Section`, 25, y + 15);
                y += 8;

                doc.autoTable({
                  startY: y,
                  head: [["Question", "Your Answer", "Score"]],
                  body: rows,
                  styles: { fontSize: 11, cellPadding: 2 },
                  headStyles: { fillColor: color, textColor: 255 },
                  alternateRowStyles: { fillColor: [250, 250, 250] },
                  margin: { top: 0 },
                  didDrawPage: data => {
                    y = data.cursor.y + 5;
                  }
                });

                doc.setFontSize(10);
                doc.setTextColor(44, 62, 80);
                doc.text(`Total Manual Score (${title}): ${sectionTotalScore}`, 15, y);
                y += 8;
              };

              addAnswerTable("Subjective", "subjective", r.subjScores || {}, [0, 31, 63]);
              addAnswerTable("Theory", "theory", r.theoryScores || {}, [0, 31, 63]);

              y += studentGap;

              if (y > pageHeight - 60) {
                doc.addPage();
                y = 10;
              }
            });

            // Section summary
            if (y > pageHeight - 40) {
              doc.addPage();
              y = 10;
            }
            if (groupedByClass) {
              doc.setFontSize(12);
              doc.setTextColor(0, 31, 63);
              doc.text(`Summary for ${section}`, 15, y);
              doc.setFontSize(11);
              doc.setTextColor(0, 31, 63);
              y += 6;
              doc.text(`Total Students: ${students.length}`, 20, y);
              doc.text(`Average Total Score: ${(sectionScoreSum / students.length).toFixed(2)}`, 120, y);
              y += 15;
            }
          });

          // Final Summary
          if (y > pageHeight - 40) {
            doc.addPage();
            y = 10;
          }
          // if (groupedByClass) {
          //     doc.setFontSize(13);
          //     doc.setTextColor(0);
          //     doc.text(`Overall Total Students: ${totalStudents}`, 15, y);
          //     doc.text(`Overall Average Score: ${(totalScoreSum / totalStudents).toFixed(2)}`, 120, y);
          // }

          // Only show overall summary if multiple sections exist
          // // Always show summary
          doc.setFontSize(13);
          doc.setTextColor(0, 31, 63);

          // If multiple sections, show overall summary
          if (groupedByClass && sortedSections.length > 1) {
            doc.text(`Overall Total Students: ${totalStudents}`, 15, y);
            doc.text(`Overall Average Score: ${(totalScoreSum / totalStudents).toFixed(2)}`, 120, y);
            y += 10;
          } else {
            // For single-section export, show section-specific summary only once
            const onlySection = sortedSections[0];
            doc.text(`Total Students: ${totalStudents}`, 15, y);
            doc.text(`Average Total Score: ${(totalScoreSum / totalStudents).toFixed(2)}`, 120, y);
            y += 10;
          }

          const pageCount = doc.internal.getNumberOfPages();
          for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text("\u00A9 Techxagon Academy - All Rights Reserved", 10, pageHeight - 10);
            doc.text(`Page ${i} of ${pageCount}`, 200, pageHeight - 10, { align: "right" });
          }

          doc.save(filename);
        };
      }

      window.downloadClasswisePDFs = async () => {
        const classOrder = [
          "JSS1 Dignity", "JSS1 Valor",
          "JSS2 Humility", "JSS2 Serenity",
          "JSS3 Excellence",
          "SS1 Creativity", "SS1 Determination",
          "SS2 Gratitude", "SS2 Virtuous",
          "SS3 Chastity"
        ];

        const normalize = str => (str || "").toLowerCase().replace(/\s+/g, "");
        const doc = new jspdf.jsPDF();
        const schoolFooter = "¬© Techxagon Academy - All Rights Reserved";
        const logo = new Image();
        logo.src = 'logo-min.png';

        const addFooter = () => {
          const pageCount = doc.internal.getNumberOfPages();
          for (let p = 1; p <= pageCount; p++) {
            doc.setPage(p);
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text(schoolFooter, 10, pageHeight - 10);
            doc.text(`Page ${p} of ${pageCount}`, 200, pageHeight - 10, { align: "right" });
          }
        };

        const getManualScore = obj => Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);
        let totalStudents = 0;

        logo.onload = () => {
          let y = 0;
          for (const classGroup of classOrder) {
            const filteredResults = results.filter(r => normalize(r.class).includes(normalize(classGroup)));
            if (filteredResults.length === 0) continue;
            totalStudents += filteredResults.length;


            y += 15;

           doc.addImage(logo, 'PNG', 10, y, 45, 20); // Logo on left

            doc.setFontSize(16);
            doc.setTextColor(33);
            doc.text(`${classGroup.toUpperCase()} TECHXAGON RESULTS  (Total: ${filteredResults.length})`, 50, y + 8); // Title beside logo

            y += 25;


            for (let i = 0; i < filteredResults.length; i++) {
              const r = filteredResults[i];
              const key = `${r.name.toLowerCase()}_${r.class.toLowerCase()}`;
              const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];

              const subjScore = getManualScore(r.subjScores);
              const theoryScore = getManualScore(r.theoryScores);


              const mcq = shuffled.filter(q => q.type === "mcq");
              const mcqScore = (r.answers || []).reduce((sum, ans, i) => {
                return mcq[i] && mcq[i].answer === ans ? sum + 1 : sum;
              }, 0);
              const manualScore = subjScore + theoryScore;
              const totalScore = mcqScore + manualScore;


              doc.setFontSize(12);
              doc.setTextColor(0, 31, 63);
              doc.text(`Name: ${r.name}`, 16, y);
              doc.text(`MCQ Score: ${mcqScore}`, 140, y);
              y += 6;
              doc.text(`Class: ${r.class}`, 16, y);
              doc.text(`Manual Score: ${manualScore}`, 140, y);
              y += 6;
              doc.text(`Date: ${r.date}`, 16, y);
              doc.text(`Total Score: ${totalScore}`, 140, y);
              y += 5;



              const mcqData = mcq.map((q, i) => {
                const studentAns = r.answers[i] || "Not answered";
                const correctAns = q.answer || "?";
                return [
                  `Q${i + 1}: ${q.question || 'Unknown'}`,
                  studentAns,
                  correctAns
                ];
              });

              doc.autoTable({
                startY: y,
                head: [["Question", "Your Answer", "Correct Answer"]],
                body: mcqData,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [0, 31, 63], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 8 }
              });

              y = doc.lastAutoTable.finalY + 3;

              const addAnswerTable = (title, typeKey, scores = {}, color) => {
                const questions = shuffled.filter(q => q.type === typeKey);
                const answers = typeKey === "subjective" ? r.subjective || {} : r.theory || {};

                let sectionTotalScore = 0;

                const rows = questions.map((q, idx) => {
                  const questionText = q.question || `Q${idx + 1}`;
                  const prefix = typeKey === "subjective" ? "subj" : "theory";
                  const key = `${prefix}_${idx}`;

                  const answerRaw = answers[key];
                  const scoreRaw = scores[key];

                  const answered = typeof answerRaw !== "undefined" && answerRaw !== "";
                  const scoreNum = typeof scoreRaw === "number" ? scoreRaw : parseInt(scoreRaw) || 0;

                  sectionTotalScore += scoreNum;

                  const answer = answered ? answerRaw : "Not answered";
                  const scoreDisplay = scoreNum.toString();

                  return [
                    questionText,
                    answer,
                    { content: scoreDisplay, styles: { textColor: scoreNum === 0 ? [192, 57, 43] : [39, 174, 96] } }
                  ];
                });

                if (!rows.length) return;

                doc.setFontSize(12);
                doc.text(`${title} Section`, 18, y + 5);
                y += 8;

                doc.autoTable({
                  startY: y,
                  head: [["Question", "Your Answer", "Score"]],
                  body: rows,
                  styles: { fontSize: 10, cellPadding: 2 },
                  headStyles: { fillColor: color, textColor: 255 },
                  alternateRowStyles: { fillColor: [250, 250, 250] },
                  margin: { top: 0 },
                  didDrawPage: data => {
                    y = data.cursor.y + 3;
                  }
                });

                doc.setFontSize(10);
                doc.setTextColor(44, 62, 80);
                doc.text(`Total Manual Score (${title}): ${sectionTotalScore}`, 18, y);
                y += 6;
              };

              addAnswerTable("Subjective", "subjective", r.subjScores || {}, [0, 31, 63]);
              addAnswerTable("Theory", "theory", r.theoryScores || {}, [0, 31, 63]);

              y += 25; // ‚Üê increased gap between students

            }

            if (classGroup !== classOrder[classOrder.length - 1]) {
              doc.addPage();
              y = 0;
            }
          }
          doc.setFontSize(14);
          doc.setTextColor(0, 31, 63);
          doc.text(`OVERALL TOTAL NUMBER OF STUDENTS: ${totalStudents}`, 20, y);
          y += 10;

          addFooter();
          doc.save(`All_Classes_Results.pdf`);
        };
        if (logo.complete) logo.onload();
      };






      window.downloadClasswiseScoress = async () => {
        const classOrder = [
          "JSS1 Dignity", "JSS1 Valor",
          "JSS2 Humility", "JSS2 Serenity",
          "JSS3 Excellence",
          "SS1 Creativity", "SS1 Determination",
          "SS2 Gratitude", "SS2 Virtuous",
          "SS3 Chastity"
        ];

        const normalize = str => (str || "").toLowerCase().replace(/\s+/g, "");
        const doc = new jspdf.jsPDF();
        const schoolFooter = "¬© Techxagon Academy - All Rights Reserved";
        const logo = new Image();
        logo.src = 'logo-min.png';

        const addFooter = () => {
          const pageCount = doc.internal.getNumberOfPages();
          for (let p = 1; p <= pageCount; p++) {
            doc.setPage(p);
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9);
            doc.setTextColor(150);
            doc.text(schoolFooter, 10, pageHeight - 10);
            doc.text(`Page ${p} of ${pageCount}`, 200, pageHeight - 10, { align: "right" });
          }
        };

        const getManualScore = obj => Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);
        let totalStudents = 0;

        logo.onload = () => {
          let y = 0;
          for (const classGroup of classOrder) {
            const filteredResults = results.filter(r => normalize(r.class).includes(normalize(classGroup)));
            if (!filteredResults.length) continue;
            totalStudents += filteredResults.length;

            y += 15;

            // Header
           doc.addImage(logo, 'PNG', 10, y, 45, 20); // Logo on left
            doc.setFontSize(16);
            doc.setTextColor(33);
            doc.text(`${classGroup.toUpperCase()} STUDENTS SUMMARY`, 50, y + 8);
            y += 25;

            doc.setFontSize(12);
            doc.text(`Class: ${classGroup.split(" ")[0]}`, 15, y);
            doc.text(`Section: ${classGroup.split(" ")[1]}`, 80, y);
            doc.text(`Total Students: ${filteredResults.length}`, 150, y);
            y += 10;

            // Build table rows
            const tableData = filteredResults.map((r, index) => {
              const key = `${r.name.toLowerCase()}_${r.class.toLowerCase()}`;
              const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];

              const getManualScore = obj => Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);
              const subjScore = getManualScore(r.subjScores);
              const theoryScore = getManualScore(r.theoryScores);
              const mcqScore = (r.answers || []).reduce((sum, ans, i) => {
                const mcq = shuffled.filter(q => q.type === "mcq");
                return mcq[i] && mcq[i].answer === ans ? sum + 1 : sum;
              }, 0);

              const totalScore = mcqScore + subjScore + theoryScore;

              return [index + 1, r.name, r.class, totalScore];
            });

            doc.autoTable({
              startY: y,
              head: [["No", "Name", "Class", "Total Score"]],
              body: tableData,
              styles: { fontSize: 11, cellPadding: 2 },
              headStyles: { fillColor: [0, 31, 63], textColor: 255 },
              alternateRowStyles: { fillColor: [245, 245, 245] },
              margin: { top: 0 },
              didDrawPage: data => {
                y = data.cursor.y + 10;
              }
            });

            if (classGroup !== classOrder[classOrder.length - 1]) {
              doc.addPage();
              y = 0;
            }
          }

          doc.setFontSize(14);
          doc.setTextColor(0, 31, 63);
          doc.text(`OVERALL TOTAL NUMBER OF STUDENTS: ${totalStudents}`, 20, y);
          y += 10;

          addFooter();
          doc.save(`All_Classes_Results.pdf`);
        };
        if (logo.complete) logo.onload();
      };











      document.getElementById("download-csv").onclick = () => {
        let csv = "Name,Class,MCQ,Manual,Total,Date\n";

        const getManualScore = obj =>
          Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);

        results.forEach(r => {
          const subjScores = r.subjScores || {};
          const theoryScores = r.theoryScores || {};
          const manual = getManualScore(subjScores) + getManualScore(theoryScores);
          const mcq = typeof r.score === "number" ? r.score : 0;
          const total = mcq + manual;

          csv += `${r.name},${r.class},${mcq},${manual},${total},${r.date}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "quiz_results.csv";
        a.click();
        URL.revokeObjectURL(url);
      };











      window.downloadAllPDFs = async () => {
        for (let i = 0; i < results.length; i++) {
          const r = results[i];

          await new Promise((resolve) => {
            const logo = new Image();
            logo.src = 'logo-min.png';

            logo.onload = () => {
              const doc = new jspdf.jsPDF();
              const schoolFooter = "¬© Techxagon Academy - All Rights Reserved";

              const addFooter = () => {
                const pageCount = doc.internal.getNumberOfPages();
                for (let p = 1; p <= pageCount; p++) {
                  doc.setPage(p);
                  const pageHeight = doc.internal.pageSize.height;
                  doc.setFontSize(9);
                  doc.setTextColor(150);
                  doc.text(schoolFooter, 10, pageHeight - 10);
                  doc.text(`Page ${p} of ${pageCount}`, 200, pageHeight - 10, { align: "right" });
                }
              };

              const getManualScore = obj => Object.values(obj || {}).reduce((sum, s) => sum + (+s || 0), 0);

              const key = `${r.name.toLowerCase()}_${r.class.toLowerCase()}`;
              const shuffled = JSON.parse(localStorage.getItem(`quiz_${key}`)) || [];

              const mcq = shuffled.filter(q => q.type === "mcq");
              const mcqScore = (r.answers || []).reduce((sum, ans, i) => {
                return mcq[i] && mcq[i].answer === ans ? sum + 1 : sum;
              }, 0);

              const subjScore = getManualScore(r.subjScores);
              const theoryScore = getManualScore(r.theoryScores);
              const totalScore = mcqScore + subjScore + theoryScore;

              doc.addImage(logo, 'PNG', 10, y, 45, 20);
              doc.setFontSize(14);
              // Left side: Name, Class, Date
              doc.text(`Name: ${r.name}`, 15, 30);
              doc.text(`Class: ${r.class}`, 15, 38);
              doc.text(`Date: ${r.date}`, 15, 46);

              // Right side: Scores
              doc.setFontSize(12);
              doc.text(`MCQ Score: ${mcqScore}`, 140, 30);
              doc.text(`Manual Score: ${subjScore + theoryScore}`, 140, 38);
              doc.text(`Total Score: ${totalScore}`, 140, 46);


              let y = 55;

              const mcqData = mcq.map((q, i) => {
                const studentAns = r.answers[i] || "Not answered";
                const correctAns = q.answer || "?";
                return [
                  `Q${i + 1}: ${q.question || 'Unknown'}`,
                  studentAns,
                  correctAns
                ];
              });

              doc.autoTable({
                startY: y,
                head: [["Question", "Your Answer", "Correct Answer"]],
                body: mcqData,
                styles: { fontSize: 9, cellPadding: 3 },
                headStyles: { fillColor: [0, 31, 63], textColor: 255 },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 10 }
              });

              y = doc.lastAutoTable.finalY + 5;

              const addAnswerTable = (title, typeKey, scores = {}, color) => {
                const questions = shuffled.filter(q => q.type === typeKey);
                const answers = typeKey === "subjective" ? r.subjective || {} : r.theory || {};

                let sectionTotalScore = 0;

                const rows = questions.map((q, idx) => {
                  const questionText = q.question || `Q${idx + 1}`;
                  const prefix = typeKey === "subjective" ? "subj" : "theory";
                  const key = `${prefix}_${idx}`;

                  const answerRaw = answers[key];
                  const scoreRaw = scores[key];

                  const answered = typeof answerRaw !== "undefined" && answerRaw !== "";
                  const scoreNum = typeof scoreRaw === "number" ? scoreRaw : parseInt(scoreRaw) || 0;

                  sectionTotalScore += scoreNum;

                  const answer = answered ? answerRaw : "Not answered";
                  const scoreDisplay = scoreNum.toString();

                  return [
                    questionText,
                    answer,
                    { content: scoreDisplay, styles: { textColor: scoreNum === 0 ? [192, 57, 43] : [39, 174, 96] } }
                  ];
                });

                if (!rows.length) return;

                doc.setFontSize(12);
                doc.text(`${title} Section`, 15, y + 5);
                y += 8;

                doc.autoTable({
                  startY: y,
                  head: [["Question", "Your Answer", "Score"]],
                  body: rows,
                  styles: { fontSize: 10, cellPadding: 2 },
                  headStyles: { fillColor: color, textColor: 255 },
                  alternateRowStyles: { fillColor: [250, 250, 250] },
                  margin: { top: 0 },
                  didDrawPage: data => {
                    y = data.cursor.y + 5;
                  }
                });

                doc.setFontSize(10);
                doc.setTextColor(44, 62, 80);
                doc.text(`Total Manual Score (${title}): ${sectionTotalScore}`, 15, y);
                y += 8;
              };

              addAnswerTable("Subjective", "subjective", r.subjScores || {}, [0, 31, 63]);
              addAnswerTable("Theory", "theory", r.theoryScores || {}, [0, 31, 63]);

              addFooter();
              doc.save(`${r.name}_${r.class}_result.pdf`);
              resolve();
            };
          });
        }
      };


      document.getElementById("clear-all-results-btn").onclick = () => {
        if (confirm("Are you sure you want to clear all results?")) {
          localStorage.removeItem("quizResults");
          location.reload();
        }
      };

      document.getElementById("logoutBtn").onclick = () => {
        if (confirm("Logout?")) window.location.href = "login.html";
        localStorage.removeItem("adminLoggedIn");
        location.href = "login.html";

      };
      // üîß Utility function to normalize keys
      function normalizeKey(str = "") {
        return str.trim().toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
      }

      // ‚úÖ Manual score update handler with UI refresh


      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("update-btn")) {
          const container = e.target.closest(".student-box");
          const key = container.dataset.key || "";
          const [nameKey, classKey] = key.split("_");

          const inputs = container.querySelectorAll("input[data-type]");
          const subjScores = {};
          const theoryScores = {};

          inputs.forEach(input => {
            const id = input.dataset.id;
            const type = input.dataset.type;
            const val = +input.value;

            if (type === "subj") subjScores[id] = val;
            else if (type === "theory") theoryScores[id] = val;
          });

          const records = JSON.parse(localStorage.getItem("quizResults") || "[]");

          // ‚úÖ Fix: Use plain lowercase comparison to find the student
          const recordIndex = records.findIndex(r =>
            r.name.toLowerCase() === nameKey &&
            r.class.toLowerCase() === classKey
          );

          if (recordIndex === -1) {
            showToast("‚ùå Student record not found");
            return;
          }

          // ‚úÖ Update scores
          records[recordIndex].subjScores = subjScores;
          records[recordIndex].theoryScores = theoryScores;

          // ‚úÖ Save back to localStorage
          localStorage.setItem("quizResults", JSON.stringify(records));

          // ‚úÖ Re-render the updated student box
          const updatedRecord = records[recordIndex];
          const newBoxHTML = renderStudentBox(updatedRecord);
          container.outerHTML = newBoxHTML;

          // ‚úÖ Rebind the Update button on the re-rendered box
          document.querySelectorAll(".update-btn").forEach(btn => {
            btn.addEventListener("click", () =>
              updateManualScore(btn.closest(".student-box"))
            );
          });

          showToast("‚úÖ Score updated successfully");
        }
      });


    });
    function clearResults() {
      localStorage.removeItem("quizResults"); // use your unified key
      alert("All quiz results have been cleared.");
    }
function handleImportFiles(fileList) {
  const mergedResults = JSON.parse(localStorage.getItem("quizResults") || "[]");

  Array.from(fileList).forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const newResults = JSON.parse(e.target.result);

        if (Array.isArray(newResults)) {
          // If file contains an array of results
          newResults.forEach(result => {
            if (!mergedResults.some(r => r.name === result.name && r.class === result.class)) {
              mergedResults.push(result);
            }
          });
        } else {
          // If file contains a single result object
          if (!mergedResults.some(r => r.name === newResults.name && r.class === newResults.class)) {
            mergedResults.push(newResults);
          }
        }

        localStorage.setItem("quizResults", JSON.stringify(mergedResults));
        alert(`Imported ${file.name} successfully`);
      } catch (err) {
        alert(`Failed to import ${file.name}: ${err.message}`);
      }
    };
    reader.readAsText(file);
  });
}


  </script>
  <div id="toast" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #2ecc71;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  display: none;
  font-weight: bold;
  z-index: 1000;
"></div>

</body>

</html>