<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Quiz Results Report</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }

    body.dark {
      background-color: #121212;
      color: #f9f9f9;
    }

    body.dark button,
    body.dark .red {
      background-color: #333;
      color: #fff;
    }

    body.dark details {
      background: #1a1a1a;
      color: #ddd;
    }

    body.dark summary {
      color: #fff;
      background: #333;
    }

    body.dark th,
    body.dark td,
    body.dark select,
    body.dark input[type="date"], body.dark input[type="text"] {
      background: #1e1e1e;
      border-color: #444;
      color: #ddd;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: transparent !important;
      border: none;
      font-size: clamp(1rem, 2vw, 1.5rem);
      cursor: pointer;
    }

    .school-header {

      margin-top: 12px;
      text-align: center;

    }

    .school-logo {
      width: 200px;
      height: auto;
      object-fit: contain;

    }

    body.dark .school-logo {
      filter: invert(1);
    }


    #quizStatsTable p {
      margin: 2px;
      font-size: clamp(.8rem, 2vw, 1rem);
    }

    #quizStatsTable h1 {
      text-align: center;
      font-size: clamp(1.2rem, 2vw, 1.7rem);
    }

    h2 {
      font-size: clamp(.8rem, 2vw, 1.3rem);
      margin: 15px 0px 10px -1px;
    }

    select,
    input[type="date"],input[type="text"] {
      margin: 10px;
      padding: clamp(.5rem, 2vw, .6rem);
      font-size: clamp(.8rem, 2vw, 1rem);
      outline:none;
      border:none;
    }
    select:focus,
    input[type="date"]:focus,input[type="text"]:focus {
      outline:none;
      border:none;
    }

    .btn,
    .blue,
    .btn.red,
    .csv-btn ,.pdf-btn{
      padding: 0.75rem 1.3rem;
      margin: 0.2rem 0.25rem;
      color: white;
      border: none;
      cursor: pointer;
      font-size: clamp(0.7rem, 2vw, 1rem);
      transition: background-color 0.3s;

    }


    .csv-btn {
      background-color: #28a745;
    }

    .blue {
      background: #337ab7;
    }

    .btn.red {
      background: #b30000;
    }
.pdf-btn{
    background-color: #934;
}
    .btn.red:hover,
    .btn:hover,
    .pdf-btn:hover,.csv-btn:hover {
      opacity: 0.9;
    }

    .btn:focus {
      outline: none;
    }

    details {
      margin: 1rem 0;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      font-size: clamp(.8rem, 2vw, 1rem);
    }
label{
    font-size: clamp(.8rem, 2vw, 1rem);
}
    summary {
      font-weight: bold;
      font-size: clamp(.8rem, 2vw, 1rem);
      cursor: pointer;
      color: #333;
      padding: 15px;

    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    td {

      padding: 10px;
    }

    th,
    td {

      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background: #eaeaea;
      padding: 8px;
    }
  </style>
</head>

<body>
  <button class="theme-toggle" id="themeToggle">üåû</button>

  <div class="school-header">
    <img src="./logo.png" alt="School Logo" class="school-logo">
  </div>

  <div id="quizStatsTable">
    <h1> üìä Third Term Quiz Results Report</h1>
    <h2>üìö Grouped by Class</h2>
    <p><strong>Total Students:</strong> <span id="totalStudents"></span></p>
    <p><strong>Total Questions:</strong> <span id="totalQuestions"></span></p>
    <p><strong>Average Score:</strong> <span id="averageScore"></span></p>

    <table>
      <tbody id="quizStatsBody"></tbody>
    </table>
  </div>

  <label for="classFilter">Filter by Class:</label>
  <select id="classFilter">
    <option value="all">All</option>
  </select>

  <label for="dateFilter">Filter by Date:</label>
  <input type="date" id="dateFilter" />
<label for="nameSearch">Search by Name:</label>
<input type="text" id="nameSearch" placeholder="Enter student name">
  <button onclick="downloadAllResults()" class="pdf-btn  px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"> üìÑ Download All</button>
  <button onclick="downloadCSV()" class="csv-btn  px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600"> üìä Download CSV</button>
  <button class="btn red" id="clear-all-btn  px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800"> üóëÔ∏è Clear All</button>
  <button class="btn blue" id="admin-logout-btn"> üîì Logout</button>


  <div id="resultsContainer"></div>

  <script>
    const clearAllBtn = document.getElementById("clear-all-btn");
    const adminLogoutBtn = document.getElementById("admin-logout-btn");
    const { jsPDF } = window.jspdf;
    const getStudentQuiz = (name, cls) => {
  const key = `${name.toLowerCase()}_${cls.toLowerCase()}`;
  const stored = localStorage.getItem(`quiz_${key}`);
  return stored ? JSON.parse(stored) : [];
};

    const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
    let questions = [];

    // Theme toggle
    const themeToggle = document.getElementById("themeToggle");
    themeToggle.onclick = () => {
      document.body.classList.toggle("dark");
      themeToggle.textContent = document.body.classList.contains("dark") ? "üåô" : "üåû";
    };

    // Filter references
    const classFilter = document.getElementById("classFilter");
    const dateFilter = document.getElementById("dateFilter");
    classFilter.onchange = () => render();
    dateFilter.onchange = () => render();
    document.getElementById("nameSearch").addEventListener("input", render);


        const uniqueClasses = [...new Set(results.map(r => r.class))].sort();
        uniqueClasses.forEach(cls => {
          const opt = document.createElement("option");
          opt.value = cls;
          opt.textContent = cls;
          classFilter.appendChild(opt);
        });

    // Populate questions from the first result

    function renderQuizStatsTable(results) {
  const tbody = document.getElementById("quizStatsBody");
  let totalQuestions = 0;
  let totalScoreSum = 0;

  results.forEach(r => {
    const quiz = getStudentQuiz(r.name, r.class);
    const score = r.answers.filter((a, i) => a === quiz[i]?.answer).length;
    totalScoreSum += score;
    totalQuestions = quiz.length; // If all quizzes are same length, fine
  });

  document.getElementById("totalStudents").textContent = results.length;
  document.getElementById("totalQuestions").textContent = totalQuestions;
  document.getElementById("averageScore").textContent = results.length > 0 
    ? (totalScoreSum / results.length).toFixed(2) 
    : "0.00";
}
 renderQuizStatsTable(results, questions);
        render();
   // Render student results
function render() {
  const searchName = document.getElementById("nameSearch").value.toLowerCase();

  const filteredResults = results.filter(r => {
    const classMatch = classFilter.value === "all" || r.class === classFilter.value;
    const dateMatch = !dateFilter.value || r.date === dateFilter.value;
    const nameMatch = r.name.toLowerCase().includes(searchName);
    return classMatch && dateMatch && nameMatch;
  });

  const grouped = {};
  filteredResults.forEach(r => {
    const key = r.class;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  const container = document.getElementById("resultsContainer");
  container.innerHTML = "";

  for (const className in grouped) {
    const details = document.createElement("details");
    details.open = true;
    const summary = document.createElement("summary");
    summary.textContent = `Class ${className} (${grouped[className].length} students)`;
    details.appendChild(summary);

    const table = document.createElement("table");
    table.innerHTML = `
      <thead>
        <tr><th>Name</th><th>Class</th><th>Score</th><th>Date</th></tr>
      </thead>
      <tbody>
        ${grouped[className]
          .sort((a, b) => a.name.localeCompare(b.name))
          .map(r => {
            const quiz = getStudentQuiz(r.name, r.class);
            const score = r.answers.filter((a, i) => a === quiz[i]?.answer).length;
            return `<tr>
  <td>${r.name}</td>
  <td>${r.class}</td>
  <td>${score}/${quiz.length}</td>
 

  <td>${r.date}</td>
  <td><button class="pdf-btn" onclick="downloadStudentPDF('${r.name}', '${r.class}')">üìÑ Download</button></td>
</tr>`;
          }).join("")}
      </tbody>`;
    details.appendChild(table);
    container.appendChild(details);
  }
}

// Download CSV using student's stored quizzes
function downloadCSV() {
  const searchName = document.getElementById("nameSearch").value.toLowerCase();
  const filteredResults = results.filter(r => {
    const classMatch = classFilter.value === "all" || r.class === classFilter.value;
    const dateMatch = !dateFilter.value || r.date === dateFilter.value;
    const nameMatch = r.name.toLowerCase().includes(searchName);
    return classMatch && dateMatch && nameMatch;
  });

  const rows = [["Name", "Class", "Score", "Date"]];
  filteredResults.forEach(r => {
    const quiz = getStudentQuiz(r.name, r.class);
    const score = r.answers.filter((a, i) => a === quiz[i]?.answer).length;

    
    
    rows.push([r.name, r.class, `${score}/${quiz.length}`, r.date]);
  });

  const csvContent = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "quiz_results.csv";
  link.click();
}



async function downloadStudentPDF(name, cls) {
  const key = `${name.toLowerCase()}_${cls.toLowerCase()}`;
  const studentData = results.find(r => r.name.toLowerCase() === name.toLowerCase() && r.class.toLowerCase() === cls.toLowerCase());
  const quiz = getStudentQuiz(name, cls);

  if (!studentData || !quiz.length) {
    alert("Quiz data not found for this student.");
    return;
  }

  const pdf = new jsPDF();

  // Load image as base64
  const logoBase64 = await loadImageAsBase64("./logo.png");

  // Header Background
  pdf.setFillColor(255, 140, 0); // Dark Orange
  pdf.rect(0, 0, 210, 25, "F"); // Full-width header rectangle

  // Logo
  pdf.addImage(logoBase64, "PNG", 10, 6, 20, 12); // Adjust size and position as needed

  // Header Text
  pdf.setTextColor(255, 255, 255); // White
  pdf.setFontSize(14);
  pdf.text("TECHXAGON ACADEMY RESULT REPORT", 105, 16, { align: "center" });

  // Reset text color for content
  pdf.setTextColor(0, 0, 0);
  pdf.setFontSize(12);
  pdf.text(`Name: ${studentData.name}`, 14, 35);
  pdf.text(`Class: ${studentData.class}`, 14, 42);
  pdf.text(`Date: ${studentData.date}`, 14, 49);

  const answers = studentData.answers;
  let score = 0;

  const body = answers.map((ans, i) => {
    const question = quiz[i]?.question || `Q${i + 1}`;
    const correct = quiz[i]?.answer || "";
    const isCorrect = ans.trim().toLowerCase() === correct.trim().toLowerCase();
    if (isCorrect) score++;

    return [
      i + 1,
      question.length > 60 ? question.slice(0, 57) + "..." : question,
      ans || "‚Äî",
      correct
    ];
  });



pdf.autoTable({
  startY: 60,
  head: [["#", "Question", "Answer", "Correct"]],
  body: body,
  styles: { fontSize: 10, cellPadding: 2 },
  headStyles: { fillColor: [0, 33, 71], textColor:255}, 
  alternateRowStyles: { fillColor: [245, 245, 245] },
  columnStyles: {
    0: { cellWidth: 12 },   // "#"
    1: { cellWidth: 100 },  // "Question"
    2: { cellWidth: 38 },   // "Answer"
    3: { cellWidth: 35 }    // "Correct"
  }
});

  pdf.setFontSize(11);
  pdf.text(`Score: ${score}/${quiz.length} (${((score / quiz.length) * 100).toFixed(1)}%)`, 14, pdf.lastAutoTable.finalY + 10);

  pdf.save(`${studentData.name}_${studentData.class}_result.pdf`);
}
async function downloadAllResults() {
  const pdf = new jsPDF();
  const logoBase64 = await loadImageAsBase64('./logo.png');

  const filteredResults = results.filter(r => {
    const classMatch = classFilter.value === "all" || r.class === classFilter.value;
    const dateMatch = !dateFilter.value || r.date === dateFilter.value;
    return classMatch && dateMatch;
  });

  const grouped = {};
  filteredResults.forEach(r => {
    const key = r.class;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  const totalPages = Object.keys(grouped).length;
  let pageIndex = 0;

  for (const className in grouped) {
    if (pageIndex > 0) pdf.addPage();
    pageIndex++;

    // HEADER background color
    pdf.setFillColor(255, 140, 0); // Dark orange
    pdf.rect(0, 0, 210, 25, 'F');

    // Logo resized (20x12 for compact header)
    pdf.addImage(logoBase64, 'PNG', 10, 6, 20, 12);
    
    pdf.setTextColor(255); // white text
    pdf.setFontSize(14);
    pdf.text("TECHXAGON ACADEMY 3RD RESULT SHEET", 105, 16, { align: "center" });
    pdf.setTextColor(0); // reset to black

    pdf.setFontSize(11);
    pdf.text(`Date: ${new Date().toLocaleDateString()}`, 160, 30);
    pdf.setFontSize(12);
    pdf.text(`Class: ${className}`, 14, 40);

    // Generate result table
    const body = grouped[className]
      .sort((a, b) => a.name.localeCompare(b.name))
      .map((r, index) => {
        const quizData = getStudentQuiz(r.name, r.class);
        let score = 0;
        if (quizData && quizData.length === r.answers.length) {
          score = r.answers.reduce((acc, ans, i) => {
            return acc + (ans === quizData[i]?.answer ? 1 : 0);
          }, 0);
        }
        return [
          index + 1,
          r.name,
          r.class,
          `${score}/${quizData.length}`,
          `${((score / quizData.length) * 100).toFixed(1)}%`,
          r.date
        ];
      });

    pdf.autoTable({
      startY: 45,
      head: [["#", "Name", "Class", "Score", "Percent", "Date"]],
      body: body,
      styles: {
        fontSize: 11,
        cellPadding: 3,
      },
      headStyles: {
        fillColor: [0, 33, 71],
        textColor: 255,
        fontStyle: 'bold',
      },
      alternateRowStyles: { fillColor: [245, 245, 245] },
      theme: "grid"
    });



    // Summary section
    const totalStudents = body.length;
    const avgPercent = (
      body.reduce((sum, row) => sum + parseFloat(row[4]), 0) / totalStudents
    ).toFixed(1);

    pdf.setFontSize(11);
    pdf.text(`Total Students: ${totalStudents}`, 14, pdf.lastAutoTable.finalY + 10);
    pdf.text(`Average Score: ${avgPercent}%`, 80, pdf.lastAutoTable.finalY + 10);

    // Page number
    pdf.setFontSize(10);
    pdf.text(`Page ${pageIndex} of ${totalPages}`, 195, 290, { align: "right" });
  }

  pdf.save("quiz_results.pdf");
}


// Load base64 image utility
function loadImageAsBase64(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      const aspectRatio = img.width / img.height;
      const width = 100;
      const height = width / aspectRatio;

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL("image/png"));
    };
    img.onerror = reject;
    img.src = url;
  });
}


      function clearAllResults() {
      if (confirm("Are you sure you want to clear ALL quiz results?")) {
        localStorage.removeItem("quizResults");
        alert("All results cleared.");
        adminResultsContainer.innerHTML = "";
      }
    }
    


    
    clearAllBtn.onclick = () => {
      clearAllResults();
      renderAdminResults();
    };
    adminLogoutBtn.onclick = () => {
     confirm("Are you sure you want to logout?") 
       window.location.href = "studentPage.html";  // <-- change this to your actual admin page
     
    };
   
  </script>
  <script src="script.js"></script>
</body>

</html>